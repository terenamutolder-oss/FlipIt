<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipIt - Master Your Memory</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192.png">
    <meta name="theme-color" content="#6366f1">

    <script>
        // Only register SW if NOT in Electron and if SW is supported
        const isElectron = /Electron/.test(navigator.userAgent);
        if ('serviceWorker' in navigator && !isElectron) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed!', err));
            });
        }
    </script>
</head>

</head>

<body>
    <!-- Global Error Overlay -->
    <div id="global-error"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; color:red; padding:2rem; overflow:auto;">
        <h2>Application Error</h2>
        <pre id="global-error-msg" style="white-space: pre-wrap; font-family: monospace;"></pre>
        <button onclick="window.location.reload()" style="padding:1rem; margin-top:1rem;">Reload App</button>
    </div>
    <script>
        window.addEventListener('error', function (event) {
            const el = document.getElementById('global-error');
            const msgEl = document.getElementById('global-error-msg');
            el.style.display = 'block';
            msgEl.textContent += `Error: ${event.message} at ${event.filename}:${event.lineno}\n`;
            console.error(event.error);
        });
        window.addEventListener('unhandledrejection', function (event) {
            const el = document.getElementById('global-error');
            const msgEl = document.getElementById('global-error-msg');
            el.style.display = 'block';
            msgEl.textContent += `Promise Rejection: ${event.reason}\n`;
        });
    </script>


    <!-- ================== AUTH VIEW ================== -->
    <section id="auth-view" class="view">
        <div class="glass-panel">
            <div class="auth-header">
                <h1>FlipIt</h1>
                <p>Master concepts faster.</p>
            </div>

            <div id="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="login-username" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <div class="error-msg" id="login-error"></div>
                <button class="btn btn-primary" id="btn-login">Log In</button>
                <div style="text-align: center; margin-top: 1rem;">
                    <span style="color: var(--text-muted)">Are you new to FlipIt? </span>
                    <span class="link-text" id="link-to-signup">Sign in</span>
                </div>
            </div>

            <div id="signup-form" class="hidden">
                <div class="form-group">
                    <label>Choose a Username</label>
                    <input type="text" id="signup-username" placeholder="Unique username">
                </div>
                <div class="form-group">
                    <label>Choose a Password</label>
                    <input type="password" id="signup-password" placeholder="Strong password">
                </div>
                <div class="error-msg" id="signup-error"></div>
                <button class="btn btn-primary" id="btn-signup">Create Account</button>
                <div style="text-align: center; margin-top: 1rem;">
                    <span style="color: var(--text-muted)">Already have an account? </span>
                    <span class="link-text" id="link-to-login">Log In</span>
                </div>
            </div>
        </div>
    </section>

    <!-- ================== HOME VIEW ================== -->
    <section id="home-view" class="view hidden">
        <div class="dashboard-header">
            <div>
                <h2>Hello, <span id="user-display-name" style="color: var(--secondary)">User</span></h2>
                <p>Ready to learn?</p>
            </div>
            <button class="btn btn-small btn-secondary" id="btn-logout">Log Out</button>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="stat-due">0</div>
                <div class="stat-label">Cards Due</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total Cards</div>
            </div>
        </div>

        <div class="action-grid">
            <button class="btn btn-primary" id="btn-start-review">
                <span>Study Now</span>
            </button>
            <button class="btn btn-secondary" id="btn-settings">
                <span>Settings</span>
            </button>
            <button class="btn btn-secondary" id="btn-create-view">
                <span>Create Flash Card</span>
            </button>
            <button class="btn btn-secondary" id="btn-export-cards">
                <span>Export Flashcards</span>
            </button>
            <button class="btn btn-secondary" id="btn-import-cards">
                <span>Import Flashcards</span>
            </button>
            <input type="file" id="input-import-file" accept=".json,application/json" class="hidden" />
        </div>
    </section>

    <!-- ================== CREATE VIEW ================== -->
    <section id="create-view" class="view hidden">
        <div class="glass-panel">
            <div class="dashboard-header">
                <h3>New Flashcard</h3>
                <button class="btn btn-small btn-secondary" id="btn-back-home-create">Back</button>
            </div>

            <div class="form-group">
                <label>Question</label>
                <textarea id="card-question" rows="3" placeholder="What do you want to ask?"></textarea>
            </div>

            <div class="form-group">
                <label>Folder (Optional)</label>
                <input type="text" id="card-folder" placeholder="e.g. Science, History...">
            </div>

            <div class="form-group">
                <label>Hint (Optional)</label>
                <input type="text" id="card-hint" placeholder="A subtle clue...">
            </div>

            <div class="form-group">
                <label>Answer</label>
                <textarea id="card-answer" rows="3" placeholder="The correct answer"></textarea>
            </div>



            <button class="btn btn-primary" id="btn-save-card">Save Card</button>
            <div id="create-msg" class="success-msg"
                style="text-align: center; margin-top: 1rem; color: var(--success);"></div>
        </div>
    </section>

    <!-- ================== SETTINGS VIEW ================== -->
    <section id="settings-view" class="view hidden">
        <div class="glass-panel">
            <div class="dashboard-header">
                <h3>Settings</h3>
                <button class="btn btn-small btn-secondary" id="btn-back-home-settings">Back</button>
            </div>

            <div class="form-group">
                <label>Appearance</label>
                <div class="action-grid">
                    <button class="btn btn-secondary" id="btn-theme-light">
                        <span>‚òÄÔ∏è Light Mode</span>
                    </button>
                    <button class="btn btn-secondary" id="btn-theme-dark">
                        <span>üåô Dark Mode</span>
                    </button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--glass-border); margin: 2rem 0;">

            <div class="form-group">
                <label>Account Management</label>
                <div class="form-group">
                    <input type="text" id="update-username" placeholder="New Username (Optional)">
                </div>
                <div class="form-group">
                    <input type="password" id="update-password" placeholder="New Password (Optional)">
                </div>
                <button class="btn btn-primary" id="btn-update-account">Update Account</button>
                <div id="update-msg" class="success-msg" style="text-align: center; margin-top: 0.5rem;"></div>
            </div>
        </div>
    </section>

    <!-- ================== REVIEW VIEW ================== -->
    <section id="review-view" class="view hidden">
        <div class="dashboard-header">
            <h3>Review Mode</h3>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-small btn-secondary" id="btn-export-current-card">Export card</button>
                <button class="btn btn-small btn-secondary" id="btn-delete-card"
                    style="border-color: var(--error); color: var(--error);">Delete</button>
                <button class="btn btn-small btn-secondary" id="btn-exit-review">Exit</button>
            </div>
        </div>

        <div id="review-container">
            <!-- Dynamic Card Injection -->
            <div class="flashcard" id="review-card">
                <div class="card-inner">
                    <div class="card-front">
                        <div class="card-text" id="review-question">Question here?</div>
                        <button class="btn btn-small btn-secondary" id="btn-show-hint">Show Hint</button>
                        <div class="hint-text" id="review-hint">Hint content</div>
                    </div>
                    <div class="card-back">
                        <div class="card-text" id="review-answer">Answer content</div>
                    </div>
                </div>
            </div>

            <div class="control-panel" style="margin-top: 2rem;">
                <!-- Step 1: Show Answer -->
                <button class="btn btn-primary" id="btn-reveal-answer">Show Answer</button>

                <!-- Step 2: Rate Logic (Hidden initially) -->
                <div id="rating-controls" class="hidden">
                    <p style="text-align: center; margin-bottom: 0.5rem; font-size: 0.875rem;">When will this question
                        appear?</p>
                    <div class="review-controls">
                        <button class="review-btn" data-interval="1m">1 min</button>
                        <button class="review-btn" data-interval="5m">5 min</button>
                        <button class="review-btn" data-interval="1h">1 hour</button>
                        <button class="review-btn" data-interval="1d">1 day</button>
                        <button class="review-btn" data-interval="7d">1 week</button>
                        <button class="review-btn" data-interval="30d">1 month</button>
                    </div>
                </div>
            </div>

            <div id="review-empty-state" class="hidden" style="text-align: center; padding: 2rem;">
                <h3>üéâ All caught up!</h3>
                <p>No more cards due for review right now.</p>
                <button class="btn btn-primary" style="margin-top: 1rem;" id="btn-back-home-review">Back to
                    Home</button>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="js/db.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/app.js"></script>
</body>

</html>